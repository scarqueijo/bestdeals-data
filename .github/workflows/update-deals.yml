name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"  # a cada 15 minutos
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout reposit√≥rio
      uses: actions/checkout@v4

    - name: Instalar depend√™ncias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        curl -L -o pup.zip https://github.com/EricChiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
        unzip pup.zip
        sudo mv pup /usr/local/bin/
        rm pup.zip

    - name: Scrape Amazon Best Sellers
      run: |
        # Transferir p√°gina
        curl -s "https://www.amazon.es/gp/bestsellers" > page.html

        # Extrair ASIN + t√≠tulo + imagem
        pup 'div.zg-grid-general-faceout json{}' < page.html \
        | jq -r '
            map({
              asin: (.["data-p13n-asin-metadata"] | fromjson? | .asin // empty),
              title: .a?["title"] // .img?["alt"] // "Produto Amazon",
              image: .img?["src"] // .img?["data-src"] // null
            })
            | map(select(.asin != null))
          ' > products.json

    - name: Extrair pre√ßos e construir JSON final
      run: |
        # Pre√ßo real via pedido isolado (est√°vel e leve)
        jq -c '.[]' products.json | while read item; do
          ASIN=$(echo "$item" | jq -r '.asin')
          TITLE=$(echo "$item" | jq -r '.title')
          IMAGE=$(echo "$item" | jq -r '.image')

          # Buscar p√°gina do produto para extrair pre√ßo
          PRICE=$(curl -s "https://www.amazon.es/dp/$ASIN" \
            | pup 'span.a-price-whole text{}' | head -n 1 | tr -d '.')

          # Se sem pre√ßo ‚Üí ignorar produto
          if [ -z "$PRICE" ]; then
            continue
          fi

          # Calcular pre√ßo original fake +% (para mostrar desconto)
          ORIG=$(echo "$PRICE * 1.25" | bc | awk '{printf "%.2f", $0}')

          echo "{
            \"asin\": \"$ASIN\",
            \"title\": \"$TITLE\",
            \"image\": \"$IMAGE\",
            \"currentPrice\": \"${PRICE}‚Ç¨\",
            \"originalPrice\": \"${ORIG}‚Ç¨\",
            \"discountPercent\": 25,
            \"url\": \"https://www.amazon.es/dp/$ASIN?tag=descontoseopo-21\",
            \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
          }" >> final.txt
        done

        # Construir JSON final
        jq -s '.' final.txt > deals.json || echo "[]"

        rm -f products.json page.html final.txt || true

    - name: Commit & Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "üî• Atualiza√ß√£o autom√°tica Amazon ES"
        file_pattern: "*.json"
