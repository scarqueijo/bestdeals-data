name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repositÃ³rio
      uses: actions/checkout@v4

    - name: Instalar dependÃªncias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        curl -L -o pup.zip https://github.com/EricChiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
        unzip pup.zip
        sudo mv pup /usr/local/bin/
        rm pup.zip

    - name: Scrape pÃ¡gina Best Sellers
      run: |
        curl -s -A "Mozilla/5.0" \
          "https://www.amazon.es/gp/bestsellers" > page.html

    - name: Extrair ASIN, TÃ­tulo e Imagem
      run: |
        pup 'div.zg-grid-general-faceout json{}' < page.html > raw-products.json

        cat << 'EOF' > filter.jq
        map({
          asin: (.["data-p13n-asin-metadata"] | fromjson? | .asin // empty),
          title: (.a?["title"] // .img?["alt"] // "Produto Amazon"),
          image: (.img?["src"] // .img?["data-src"] // null)
        })
        | map(select(.asin != null))
        EOF

        jq -f filter.jq raw-products.json > products.json
        rm filter.jq raw-products.json page.html

    - name: Obter preÃ§os reais por produto
      run: |
        rm -f final.txt || true

        jq -c '.[]' products.json | while read item; do
          ASIN=$(echo "$item" | jq -r '.asin')
          TITLE=$(echo "$item" | jq -r '.title')
          IMAGE=$(echo "$item" | jq -r '.image')

          PRICE=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            -H "Accept-Language: es-ES,es;q=0.9" \
            "https://www.amazon.es/dp/$ASIN" \
            | pup 'span.a-price-whole text{}' \
            | head -n 1 \
            | tr -d '.')

          if [ -z "$PRICE" ]; then
            continue
          fi

          ORIGINAL=$(echo "$PRICE * 1.25" | bc | awk '{printf "%.2f", $0}')

          echo "{
            \"asin\": \"$ASIN\",
            \"title\": \"$TITLE\",
            \"image\": \"$IMAGE\",
            \"currentPrice\": \"${PRICE}â‚¬\",
            \"originalPrice\": \"${ORIGINAL}â‚¬\",
            \"discountPercent\": 25,
            \"url\": \"https://www.amazon.es/dp/$ASIN?tag=descontoseopo-21\",
            \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
          }" >> final.txt
        done

        jq -s '.' final.txt > deals.json || echo "[]" > deals.json
        rm -f final.txt

    - name: Commit & Push resultados (sem conflitos)
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git pull --rebase origin main || true
        git add deals.json
        git commit -m "ðŸ”¥ AtualizaÃ§Ã£o automÃ¡tica Amazon ES" || true
        git push origin HEAD:main || true
