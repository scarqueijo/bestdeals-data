name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Instalar jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Buscar Ofertas Amazon.es (Fonte Estável)
      run: |
        curl -s "https://api.apify.com/v2/datasets/rxQ3wQJ8ZC3LOJ28F/items?clean=true&format=json" \
        | jq '[ .[] 
            | select(.oldPrice != null and .price != null)
            | {
                title: .title,
                asin: .asin,
                image: .image,
                originalPrice: .oldPrice,
                currentPrice: .price,
                discountPercent: (((.oldPrice - .price) / .oldPrice) * 100 | floor)
              }
          ]' > deals.json

    - name: Commit & Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Atualização automática ✅"
