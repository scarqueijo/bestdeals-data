name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"   # Atualiza a cada 15 minutos
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Instalar jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Buscar Descontos Amazon.es (Dataset P√∫blico Apify)
      run: |
        # Buscar dataset p√∫blico e est√°vel de ofertas Amazon ES
        curl -s "https://api.apify.com/v2/datasets/rxQ3wQJ8ZC3LOJ28F/items?clean=true&format=json" > raw.json

        # Criar filtro em jq
        cat << 'EOF' > filter.jq
        [
          .[]
          | select(.price != null and .oldPrice != null and (.oldPrice > .price))
          | {
              title: .title,
              asin: .asin,
              image: .image,
              originalPrice: .oldPrice,
              currentPrice: .price,
              discountPercent: (((.oldPrice - .price) / .oldPrice) * 100 | floor),
              url: ("https://www.amazon.es/dp/" + .asin + "?tag=descontoseopo-21"),
              created: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }
        ]
        | sort_by(-.discountPercent)
        EOF

        # Processar com jq
        jq -f filter.jq raw.json > deals.json
        rm filter.jq raw.json

    - name: Validar dados
      run: |
        if [ ! -s deals.json ]; then
          echo "‚ùå Erro: deals.json est√° vazio"
          exit 1
        fi

        COUNT=$(jq length deals.json)
        echo "‚úÖ Encontrados $COUNT produtos com desconto"

        if [ "$COUNT" -eq 0 ]; then
          echo "‚ö†Ô∏è Nenhum desconto v√°lido encontrado"
          exit 1
        fi

    - name: Commit & Push resultados
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ü§ñ Atualiza√ß√£o autom√°tica de descontos Amazon ES"
        commit_user_name: "GitHub Actions Bot"
        commit_user_email: "actions@github.com"
        file_pattern: '*.json'

      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Atualiza√ß√£o autom√°tica ‚úÖ"
