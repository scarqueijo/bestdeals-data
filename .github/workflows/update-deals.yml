name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *" # Atualiza a cada 15 minutos
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repositÃ³rio
      uses: actions/checkout@v4

    - name: Instalar dependÃªncias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Buscar descontos do Chollometro (Amazon.es)
      run: |
        curl -s "https://www.chollometro.com/rest_api/v3/deals?page=1&per_page=80&search=amazon.es" > raw.json

        # Criar products.json limpo
        jq '
          .data[]
          | select(.price_old != null and .price != null and (.price_old > .price))
          | {
              title: .title,
              url: .url,
              originalPrice: (.price_old | tostring + "â‚¬"),
              currentPrice: (.price | tostring + "â‚¬"),
              discountPercent: (((.price_old - .price) / .price_old) * 100 | floor),
              asin: (
                (.url | capture("dp/(?<id>[A-Z0-9]{10})")?.id) // "UNKNOWN"
              ),
              image: .thumbnail,
              updatedAt: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }
          | select(.asin != "UNKNOWN")
        ' raw.json > products.json

    - name: Remover eventos duplicados e ordenar por maior desconto
      run: |
        jq 'sort_by(-.discountPercent)' products.json > deals.json

    - name: Commit & Push sem conflitos
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git pull --rebase origin main || true

        git add deals.json products.json
        git commit -m "ðŸ”¥ AtualizaÃ§Ã£o automÃ¡tica Amazon ES" || true
        git push origin HEAD:main || true
