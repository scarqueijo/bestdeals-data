name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *" # a cada 15 minutos
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout reposit√≥rio
      uses: actions/checkout@v4

    - name: Instalar depend√™ncias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        curl -L -o pup.zip https://github.com/EricChiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
        unzip pup.zip
        sudo mv pup /usr/local/bin/
        rm pup.zip

    - name: Transferir p√°gina Amazon Best Sellers
      run: |
        curl -s "https://www.amazon.es/gp/bestsellers" > page.html

    - name: Extrair produtos (ASIN, T√≠tulo, Imagem)
      run: |
        # Extra√ß√£o HTML ‚Üí JSON b√°sico
        pup 'div.zg-grid-general-faceout json{}' < page.html > raw-products.json

        # Filtro jq protegido com HEREDOC (n√£o quebra o //)
        cat << 'EOF' > filter.jq
        map({
          asin: (
            .["data-p13n-asin-metadata"]
            | fromjson?
            | .asin // empty
          ),
          title: (
            .a?["title"]
            // .img?["alt"]
            // "Produto Amazon"
          ),
          image: (
            .img?["src"]
            // .img?["data-src"]
            // null
          )
        })
        | map(select(.asin != null))
        EOF

        jq -f filter.jq raw-products.json > products.json
        rm filter.jq raw-products.json page.html

    - name: Obter pre√ßos e construir deals.json
      run: |
        rm -f final.txt || true

        jq -c '.[]' products.json | while read item; do
          ASIN=$(echo "$item" | jq -r '.asin')
          TITLE=$(echo "$item" | jq -r '.title')
          IMAGE=$(echo "$item" | jq -r '.image')

          PRICE=$(curl -s "https://www.amazon.es/dp/$ASIN" \
            | pup 'span.a-price-whole text{}' \
            | head -n 1 \
            | tr -d '.')

          # Se n√£o houver pre√ßo ‚Üí ignorar
          if [ -z "$PRICE" ]; then
            continue
          fi

          ORIGINAL=$(echo "$PRICE * 1.25" | bc | awk '{printf "%.2f", $0}')

          echo "{
            \"asin\": \"$ASIN\",
            \"title\": \"$TITLE\",
            \"image\": \"$IMAGE\",
            \"currentPrice\": \"${PRICE}‚Ç¨\",
            \"originalPrice\": \"${ORIGINAL}‚Ç¨\",
            \"discountPercent\": 25,
            \"url\": \"https://www.amazon.es/dp/$ASIN?tag=descontoseopo-21\",
            \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
          }" >> final.txt
        done

        jq -s '.' final.txt > deals.json || echo "[]"
        rm -f final.txt

    - name: Commit & Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "üî• Atualiza√ß√£o autom√°tica Amazon ES"
        file_pattern: "*.json"
