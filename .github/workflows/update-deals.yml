name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Instalar jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Buscar Ofertas Amazon.es (GoldBox Est√°vel)
      run: |
        # Buscar feed est√°vel da Apify (n√£o expira)
        curl -s "https://api.apify.com/v2/key-value-stores/QQytVQW9bu5fuw6zH/records/OUTPUT?clean=true" > raw.json

        cat << 'EOF' > filter.jq
        [
          .deals[]
          | select(.oldPrice != null and .price != null and (.oldPrice > .price))
          | {
              title: .title,
              asin: .asin,
              image: .image,
              originalPrice: .oldPrice,
              currentPrice: .price,
              discountPercent: (((.oldPrice - .price) / .oldPrice) * 100 | floor),
              url: ("https://www.amazon.es/dp/" + .asin + "?tag=descontoseopo-21"),
              created: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }
        ]
        | sort_by(-.discountPercent)
        EOF

        jq -f filter.jq raw.json > deals.json
        rm filter.jq raw.json

    - name: Validar dados
      run: |
        COUNT=$(jq length deals.json)
        echo "‚úÖ Encontrados $COUNT descontos v√°lidos"
        if [ "$COUNT" -eq 0 ]; then
          echo "‚ö†Ô∏è Nenhum desconto v√°lido encontrado"
          exit 1
        fi

    - name: Commit & Push resultados
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ü§ñ Atualiza√ß√£o autom√°tica Amazon ES"
        file_pattern: '*.json'
