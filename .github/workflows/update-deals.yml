name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *" # Executa a cada 15 minutos
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repositÃ³rio
      uses: actions/checkout@v4

    - name: Instalar dependÃªncias necessÃ¡rias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        curl -L -o pup.zip https://github.com/EricChiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
        unzip pup.zip
        sudo mv pup /usr/local/bin/
        rm pup.zip

    - name: Transferir pÃ¡gina Amazon Best Sellers
      run: |
        curl -s "https://www.amazon.es/gp/bestsellers" > page.html

    - name: Extrair ASIN / TÃ­tulo / Imagem
      run: |
        pup 'div.zg-grid-general-faceout json{}' < page.html > raw-products.json

        cat << 'EOF' > filter.jq
        map({
          asin: (.["data-p13n-asin-metadata"] | fromjson? | .asin // empty),
          title: (.a?["title"] // .img?["alt"] // "Produto Amazon"),
          image: (.img?["src"] // .img?["data-src"] // null)
        })
        | map(select(.asin != null))
        EOF

        jq -f filter.jq raw-products.json > products.json
        rm filter.jq raw-products.json page.html

    - name: Obter preÃ§os e gerar deals.json final
      run: |
        rm -f final.txt || true

        jq -c '.[]' products.json | while read item; do
          ASIN=$(echo "$item" | jq -r '.asin')
          TITLE=$(echo "$item" | jq -r '.title')
          IMAGE=$(echo "$item" | jq -r '.image')

          PRICE=$(curl -s "https://www.amazon.es/dp/$ASIN" \
            | pup 'span.a-price-whole text{}' \
            | head -n 1 \
            | tr -d '.')

          if [ -z "$PRICE" ]; then
            continue
          fi

          ORIGINAL=$(echo "$PRICE * 1.25" | bc | awk '{printf "%.2f", $0}')

          echo "{
            \"asin\": \"$ASIN\",
            \"title\": \"$TITLE\",
            \"image\": \"$IMAGE\",
            \"currentPrice\": \"${PRICE}â‚¬\",
            \"originalPrice\": \"${ORIGINAL}â‚¬\",
            \"discountPercent\": 25,
            \"url\": \"https://www.amazon.es/dp/$ASIN?tag=descontoseopo-21\",
            \"updatedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
          }" >> final.txt
        done

        jq -s '.' final.txt > deals.json || echo "[]" > deals.json
        rm -f final.txt

    - name: Commit & Push resultados corrigido (sem conflitos)
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git pull --rebase origin main || true

        git add deals.json
        git commit -m "ðŸ”¥ AtualizaÃ§Ã£o automÃ¡tica Amazon ES" || true
        git push origin HEAD:main || true
