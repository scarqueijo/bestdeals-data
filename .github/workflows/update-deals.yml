name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-deals
  cancel-in-progress: true

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Obter deals da API Pepper (Chollometro ‚Üí Amazon ES)
        run: |
          set -euo pipefail

          curl -fsSL --retry 3 --max-time 30 \
            -H "User-Agent: bestdeals-bot/1.0" \
            "https://api.pepper.com/v1/deals?domain=chollometro.com&search=amazon.es&limit=100" \
            > raw.json

          jq '
            .data[]?
            | select(.price_previous != null and .price != null and (.price_previous > .price))
            | {
                title: .title,
                asin: (
                  try (.url | match("dp/([A-Z0-9]{10})") | .captures[0].string)
                  catch "UNKNOWN"
                ),
                image: .thumbnail,
                originalPrice: (.price_previous | tostring + "‚Ç¨"),
                currentPrice: (.price | tostring + "‚Ç¨"),
                discountPercent: (
                  if (.price_previous // 0) > 0 then
                    (((.price_previous - .price) / .price_previous) * 100 | floor)
                  else 0 end
                ),
                url: .url,
                source: "pepper-api",
                fetchedAt: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }
            | select(.asin != "UNKNOWN")
            | sort_by(-.discountPercent)
          ' raw.json > deals.json

          if [ ! -s deals.json ] || [ "$(jq 'length' deals.json)" -eq 0 ]; then
            echo "‚úÖ Nenhum desconto v√°lido nesta execu√ß√£o. Workflow neutro."
            exit 78
          fi

          echo "‚úÖ Encontrados $(jq 'length' deals.json) produtos com desconto."

      - name: Commit & Push (sem conflitos)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git pull --rebase origin main || true

          git add deals.json
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è Sem altera√ß√µes."
          else
            git commit -m "üî• Atualiza√ß√£o autom√°tica Amazon ES - $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push origin main
            echo "‚úÖ Push efetuado."
          fi
