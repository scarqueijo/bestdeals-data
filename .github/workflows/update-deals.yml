name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/15 * * * *"   # a cada 15 minutos
  workflow_dispatch:

# necess√°rio para o bot poder escrever no reposit√≥rio
permissions:
  contents: write

concurrency:
  group: update-deals
  cancel-in-progress: true

jobs:
  update-deals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Obter deals do Chollometro (amazon.es)
        run: |
          set -euo pipefail

          # 1) Buscar p√°gina com timeout e reintentos
          curl -fsSL --retry 3 --max-time 30 \
            -H "User-Agent: bestdeals-bot/1.0" \
            "https://www.chollometro.com/rest_api/v3/deals?page=1&per_page=100&search=amazon.es" \
            > raw.json

          # 2) Validar JSON bruto (falha cedo se vier HTML/erro)
          jq -e . raw.json >/dev/null

          # 3) Filtro jq robusto (heredoc QUOTED para n√£o expandir no shell)
          cat <<'JQ' > filter.jq
          [
            (.data // [])[]? 
            | select(.price_old != null and .price != null and (.price_old > .price))
            | {
                title: (.title // "Produto Amazon"),
                asin: (
                  try ((.url // "") | match("dp/([A-Z0-9]{10})") | .captures[0].string)
                  catch (
                    try ((.url // "") | match("/product/([A-Z0-9]{10})") | .captures[0].string)
                    catch "UNKNOWN"
                  )
                ),
                image: (.thumbnail // null),
                originalPrice: (.price_old // 0),
                currentPrice: (.price // 0),
                discountPercent: (
                  if (.price_old // 0) > 0 then
                    (((.price_old - .price) / .price_old) * 100 | floor)
                  else 0 end
                ),
                url: (.url // null),
                source: "chollometro",
                fetchedAt: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }
            | select(.asin != "UNKNOWN")
          ]
          | sort_by(-.discountPercent)
          JQ

          # 4) Produzir deals.json em linha √∫nica (-c) para evitar ‚Äúum item por linha‚Äù
          jq -c -f filter.jq raw.json > deals.json

          # 5) Sanidade: se vazio, sair neutro para n√£o falhar o workflow
          if [ ! -s deals.json ] || [ "$(jq 'length' deals.json)" -eq 0 ]; then
            echo "‚úÖ Sem descontos v√°lidos nesta execu√ß√£o."
            exit 78   # neutral
          fi

          echo "‚úÖ Encontrados $(jq 'length' deals.json) produtos com desconto."

      - name: Commit & Push (com rebase para evitar non-fast-forward)
        if: success() || failure() && steps.Obter_deals_do_Chollometro__amazon_es_.outcome != 'failure'
        run: |
          set -e

          # Definir identidade do bot
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Atualizar do remoto para evitar rejei√ß√µes
          git pull --rebase origin "$(git rev-parse --abbrev-ref HEAD)" || true

          # S√≥ commita se houver altera√ß√µes
          git add deals.json
          if ! git diff --cached --quiet; then
            git commit -m "ü§ñ Atualiza√ß√£o autom√°tica Amazon ES - $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push origin HEAD
            echo "‚úÖ Push efetuado."
          else
            echo "‚ÑπÔ∏è Sem altera√ß√µes para commit."
          fi
