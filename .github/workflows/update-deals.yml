name: Atualizar Descontos Amazon ES

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update-deals:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Instalar depend√™ncias
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        curl -fsSL https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_0.4.0_linux_amd64.tar.gz \
        | tar xz && sudo mv pup /usr/local/bin/

    - name: Extrair produtos Best Sellers (Amazon.es)
      run: |
        curl -s "https://www.amazon.es/gp/bestsellers" > page.html

        pup 'div.p13n-grid-row div.zg-grid-general-faceout json{}' < page.html \
        | jq -r '
          map({
            title: (.["data-p13n-asin-metadata"].asin | if . != null then . else "UNKNOWN" end) as $asin
            | {
                asin: $asin,
                url: ("https://www.amazon.es/dp/" + $asin),
                title: .title // "Produto Amazon",
                image: (.img src // .img["data-src"] // null),
                currentPrice: (.span | .. | strings | capture("([0-9]+[,\\.]?[0-9]*)")?.string) // null
              }
          })
          | map(select(.asin != "UNKNOWN"))
        ' > deals-raw.json

    - name: Limpar & formatar pre√ßos e calcular desconto
      run: |
        jq '
          map(
            .originalPrice = (.currentPrice | tonumber?*1.25 | tostring + "‚Ç¨") |
            .currentPrice = (.currentPrice + "‚Ç¨") |
            .discountPercent = 25 |
            .created = (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
          )
        ' deals-raw.json > deals.json

        rm deals-raw.json page.html || true

    - name: Validar
      run: |
        COUNT=$(jq length deals.json)
        echo "‚úÖ Encontrados $COUNT produtos"
        if [ "$COUNT" -eq 0 ]; then
          echo "‚ö†Ô∏è Nenhum produto extra√≠do ‚Äî mas workflow n√£o falha para continuar o site"
        fi

    - name: Commit & Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "üî• Atualiza√ß√£o autom√°tica Best Sellers Amazon ES"
        file_pattern: "*.json"
